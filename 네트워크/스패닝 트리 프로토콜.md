## 스패닝 트리 알고리즘(STP)
스위치나 브리지에서 발생하는 루핑을 막아주기 위한 프로토콜.  
스위치나 브리지 구성에서 출발지에서 목적지까지의 경로가 두 개 이상 존재할 때 한 개의 경로만 남겨두고 나머지 경로는 모두 끊어두었다가 사용하던 경로에 문제가 발생하면 그때 끊어 두었던 경로를 하나씩 살린다.  

### 스패닝 트리 프로토콜을 이해하기 위한 기본 개념 2가지
* 브리지 ID  
브리지나 스위치들이 통신할 때 서로를 확인하기 위해 하나씩 가지고 있는 번호라고 생각하면 됨.  
* 브리지 ID 만드는 규칙  
16비트의 브리지 우선 순위와 48비트의 맥 어드레스로 만들어짐.  
브리지 우선 순위에 올 수 있는 수는 0부터 2의 16승 -1까지(0~65535)/ 브리지 우선 순위는 디폴트로 그 중간에 해당하는 값인 32768을 사용함.(32768을 16진수로 바꾸면 8000이 됨.)  
브리지 우선 순위 뒤에 오는 맥 어드레스는 스위치에 고정되어 있는 값.  

Path Cost  
‘길에 들어가는 비용’. 네트워크에서 길이란 바로 장비와 장비가 연결되어 있는 링크를 말함.  
브리지가 얼마나 가까이, 그리고 빠른 링크로 연결되어 있는지를 알아내기 위한 값.  
1000Mbps를 두 장비 사이의 링크 대역폭으로 나눈 값을 사용.  
예시)  
두 스위치가 10Mbps로 연결되어 있고, Path Cost는 1000Mbps를 둘 사이의 링크 대역폭으로 나눈 값 => 1000/10 = 100이 Path Cost  
Path Cost는 링크의 속도가 빠르면 빠를수록 더 작은 값이 됨.  
근데 다양한 속도들이 나오는 바람에 소수점이 나오게 되어 이를 막기 위해 정수값으로 Path Cost값을 지정  
대역폭(Bandwidth)   STP Cost(Path Cost)  
10메가                      100  
100메가                    19  
기가비트                    4  
### 스패닝 트리 기본적인 동작 3가지
1. 네트워크 당 하나의 루트 브리지를 갖는다.  
여기서의 네트워크는 스위치/브리지로 구성된 하나의 네트워크. 따라서 라우터에 의해 나누어지는 브로드캐스트 도메인이 하나의 네트워크라고 생각하면 된다. 즉, 하나의 브로드캐스트 도메인에 하나씩의 루트 브리지가 있음.  
루트 브리지? 한마디로 대장 브리지. 스패닝 트리 프로토콜을 수행할 때 기준이 되는 브리지(스위치)를 말함.  

2. 루트 브리지가 아닌 나머지 모든 브리지(Non Root Bridge)는 무조건 하나씩의 루트 포트를 갖는다.  
Non Root Bridge당 하나씩의 루트 포트를 가져야 한다.  
루트 포트란? 루트 브리지에 가장 빨리 갈 수 있는 포트를 말함. 즉, 루트 브리지 쪽에 가장 가까운 포트라고 볼 수 있음.  


3. 세그먼트당 하나씩의 데지그네이티드 포트(지정 포트/Designated Port)를 갖는다.  
세그먼트란? 브리지/스위치 간에 서로 연결된 링크라고 보면 됨. 즉, 브리지/스위치가 서로 연결되어 있을 때 이 세그먼트에서 반드시 한 포트는 지정 포트로 선출되어야 함.  
=> 결론적으로 스패닝 트리 프로토콜은 위 3가지 규칙을 적용해서 어느쪽 링크를 살려두고 끊을지 결정하는 과정이다.  
스패닝 트리 프로토콜에서 루트 포트나 데지그네이티드 포트가 아닌 나머지 모든 포트는 다 막아버린다.즉, 루트 포트나 데지그네이티드 포트를 뽑는 목적은 어떤 포트를 살릴지 결정하기 위한 것.  

### 스패닝 트리 프로토콜에서 어떻게 순서를 정하는가?
누가 루트 브리지가 될지 정하고, 누가 데지그네이티드 포트가 될지 정하는 순서.  
1단계 누가 더 작은 Root BID를 가졌는가?  
2단계 루트 브리지까지의 Path Cost값은 누가 더 작은가?  
3단계 누구의 BID(Sender BID)가 더 낮은가?  
4단계 누구의 포트 ID가 더 낮은가?  

위 4단계를 거쳐 데지그네이티드 포트와 나머지 포트인 Non Designated 포트로 지정한다.  

브리지/스위치는 스패닝 트리 정보를 자기들끼리 주고받기 위해 특수한 프레임을 사용하는데, 이를 BPDU(Bridge Protocol Data Unit)이라고 함.  
BPDU에는 루트 브리지의 BID(브리지 ID)인 Root BID, 루트 브리지까지 가는 경로값인 Root Path Cost, 보내는 브리지의 BID인 Sender BID, 어떤 포트에서 보냈는지 알게 해주는 Port ID 정보 등이 실려 있음.  
브리지/스위치가 부팅을 하면 이들은 각각의 포트로 BPDU를 매 2초마다 내보내면서 서로의 스패닝 트리 정보를 주고 받음.  

루트 브리지의 모든 포트들은 언제나 데지그네이티드 포트로 선정된다.   

스패닝 트리 프로토콜을 구현해 나가는 과정에서 모든 스위치/브리지의 포트들은 언제나 5가지 상태로 변함.  
* Disabled
이 상태는 포트가 고장나서 사용할 수 없거나 네트워크 관리자가 포트를 일부러 셧다운 시켜놓은 상태.  
데이터 전송 => 안 됨. 맥 어드레스를 배울 수 없고, BPDU 못 주고 받음  
* Blocking  
스위치를 맨 처음 켜거나 Disabled되어 있는 포트를 관리자가 다시 살렸을 때 그 포트는 블로킹 상태로 들어감.  
데이터 전송 되지 않고 오직 BPDU만 주고받을 수 있음. 맥어드레스 못배움.  
* Listening
블로킹 상태에 있던 스위치 포트가 루트 포트나 데지그네이티드 포트로 선정되면 포트는 바로 리스닝 상태로 넘어감.(물론 리스닝 상태에 있던 포트도 네트워크에 새로운 스위치가 접속했거나 브리지나 스위치의 구성값들이 바뀌면 루트 포트나 데지그네이티드 포트에서 논 데지그네이티드 포트로 상황이 변할 수도 있다.  그렇게 되면 다시 블로킹 상태로 돌아가게 됨.)  
데이터 전송은 아직 안 되고, 맥 어드레스 못 배우고, BPDU는 주고 받는다.  
* Learning
리스닝 상태의 스위치 포트가 포워딩 딜레이 디폴트 시간인 15초 동안 그 상태를 계속 유지하면 리스닝 상태는 러닝 상태로 넘어감.  
데이터 전송은 아직까지 안 되고, 맥 어드레스는 배우기 시작한다. BPDU는 주고 받는다.  
* Forwarding
스위치 포트가 러닝 상태에서 다른 상태로 넘어가지 않고, 다시 포워딩 딜레이 디폴트 시간이 15초 동안 그 상태를 계속 유지하면 러닝 상태에서 포워딩 상태로 넘어가게 됨. 포워딩 상태가 되어야 스위치 포트는 드디어 데이터 프레임을 주고받을 수 있게 됨. 이제 데이터 전송 시작되고, 계속 맥 어드레스를 배워 브리지 테이블을 만들고, BPDU 주고 받는다.  

위 내용은 후니의 쉽게 쓴 시스코 네트워킹을 바탕으로 요약 정리하였습니다.
